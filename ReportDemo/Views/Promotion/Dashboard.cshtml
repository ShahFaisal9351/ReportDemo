@model List<ReportDemo.Controllers.StudentEligibilityVM>
@{
    ViewData["Title"] = "Promotion Analytics Dashboard";
    Layout = "_DashboardLayout";
    var classes = ViewBag.Classes as List<ReportDemo.Models.Class>;
    var selectedClassId = ViewBag.SelectedClassId as int?;
    var academicYear = ViewBag.CurrentAcademicYear as string;
    var classInfo = ViewBag.Class as ReportDemo.Models.Class;
    bool canPromote = ViewBag.CanPromote as bool? ?? false;
    var nextClass = ViewBag.NextClass as ReportDemo.Models.Class;
    var promotionHistory = ViewBag.PromotionHistory as List<ReportDemo.Models.PromotionHistory>;
    var allClassesStats = ViewBag.AllClassesStats as List<dynamic>;
}

<style>
    :root {
        --primary-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        --success-gradient: linear-gradient(135deg, #11998e 0%, #38ef7d 100%);
        --warning-gradient: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        --info-gradient: linear-gradient(135deg, #373B44 0%, #4286f4 100%);
        --card-shadow: 0 10px 40px rgba(0,0,0,0.1);
        --hover-shadow: 0 20px 60px rgba(0,0,0,0.15);
        --transition-smooth: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
    }

    body {
        background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
        min-height: 100vh;
    }

    .promo-header {
        background: var(--primary-gradient);
        color: white;
        border-radius: 20px;
        padding: 2.5rem;
        box-shadow: var(--card-shadow);
        position: relative;
        overflow: hidden;
    }

    .promo-header::before {
        content: '';
        position: absolute;
        top: -50%;
        right: -10%;
        width: 300px;
        height: 300px;
        background: rgba(255,255,255,0.1);
        border-radius: 50%;
        animation: float 6s ease-in-out infinite;
    }

    @@keyframes float {
        0%, 100% { transform: translateY(0px); }
        50% { transform: translateY(-20px); }
    }

    .glass-card {
        background: rgba(255,255,255,0.95);
        border: none;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
        transition: var(--transition-smooth);
        backdrop-filter: blur(10px);
    }

    .glass-card:hover {
        transform: translateY(-5px);
        box-shadow: var(--hover-shadow);
    }

    .stats-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        transition: var(--transition-smooth);
        position: relative;
        overflow: hidden;
        border: none;
    }

    .stats-card:hover {
        transform: translateY(-10px);
        box-shadow: var(--hover-shadow);
    }

    .stats-card::before {
        content: '';
        position: absolute;
        top: 0;
        left: 0;
        width: 4px;
        height: 100%;
    }

    .stats-card.eligible::before { background: var(--success-gradient); }
    .stats-card.conditional::before { background: var(--warning-gradient); }
    .stats-card.not-eligible::before { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
    .stats-card.total::before { background: var(--info-gradient); }

    .stats-icon {
        width: 60px;
        height: 60px;
        border-radius: 15px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.5rem;
        margin-bottom: 1rem;
        color: white;
    }

    .stats-icon.eligible { background: var(--success-gradient); }
    .stats-icon.conditional { background: var(--warning-gradient); }
    .stats-icon.not-eligible { background: linear-gradient(135deg, #f5576c 0%, #f093fb 100%); }
    .stats-icon.total { background: var(--info-gradient); }

    .stats-number {
        font-size: 2.5rem;
        font-weight: 800;
        margin-bottom: 0.5rem;
    }

    .stats-number.eligible { color: #11998e; }
    .stats-number.conditional { color: #f093fb; }
    .stats-number.not-eligible { color: #f5576c; }
    .stats-number.total { color: #373B44; }

    .stats-label {
        color: #6c757d;
        font-size: 0.9rem;
        font-weight: 500;
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .modern-table {
        background: white;
        border-radius: 20px;
        overflow: hidden;
        box-shadow: var(--card-shadow);
    }

    .modern-table thead {
        background: var(--primary-gradient);
        color: white;
    }

    .modern-table thead th {
        border: none;
        padding: 1.5rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 1px;
        font-size: 0.85rem;
    }

    .modern-table tbody tr {
        transition: var(--transition-smooth);
        border-bottom: 1px solid #f1f3f5;
    }

    .modern-table tbody tr:hover {
        background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
        transform: scale(1.01);
    }

    .modern-table tbody td {
        padding: 1.5rem;
        vertical-align: middle;
        border: none;
    }

    .status-badge {
        border-radius: 25px;
        font-weight: 600;
        font-size: 0.8rem;
        text-transform: uppercase;
        letter-spacing: 1px;
        padding: 0.5rem 1rem;
    }

    .status-Eligible { background: #e8f5e9; color: #1b5e20; }
    .status-Conditional { background: #fff8e1; color: #8d6e00; }
    .status-Not\ Eligible { background: #ffebee; color: #b71c1c; }

    .filter-btn {
        border-radius: 25px;
        padding: 0.5rem 1.5rem;
        font-weight: 600;
        border: 2px solid transparent;
        transition: var(--transition-smooth);
    }

    .filter-btn:hover {
        transform: translateY(-2px);
    }

    .filter-btn.active {
        background: var(--primary-gradient);
        color: white;
        border-color: transparent;
    }

    .action-btn {
        border-radius: 15px;
        padding: 0.75rem 1.5rem;
        font-weight: 600;
        border: none;
        transition: var(--transition-smooth);
        text-transform: uppercase;
        letter-spacing: 1px;
    }

    .action-btn:hover {
        transform: translateY(-3px);
        box-shadow: 0 10px 25px rgba(0,0,0,0.2);
    }

    .progress-ring {
        transform: rotate(-90deg);
    }

    .progress-ring-circle {
        transition: stroke-dashoffset 0.35s;
        transform-origin: 50% 50%;
    }

    .chart-container {
        position: relative;
        height: 300px;
        background: white;
        border-radius: 20px;
        padding: 2rem;
        box-shadow: var(--card-shadow);
    }

    .history-card {
        background: white;
        border-radius: 20px;
        padding: 1.5rem;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
        transition: var(--transition-smooth);
        border-left: 4px solid;
    }

    .history-card:hover {
        transform: translateX(5px);
        box-shadow: var(--hover-shadow);
    }

    .history-card.success { border-left-color: #11998e; }
    .history-card.pending { border-left-color: #f093fb; }
    .history-card.failed { border-left-color: #f5576c; }

    .empty-state {
        text-align: center;
        padding: 4rem 2rem;
        background: white;
        border-radius: 20px;
        box-shadow: var(--card-shadow);
    }

    .empty-state-icon {
        font-size: 5rem;
        color: #dee2e6;
        margin-bottom: 2rem;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .sticky-head th { position: sticky; top: 0; z-index: 1; }
    .filter-pill { border-radius: 999px }
</style>

<div class="container-fluid">
    <!-- Modern Header -->
    <div class="promo-header mb-4">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h1 class="text-white mb-3">
                    <i class="fas fa-chart-line me-3"></i>Promotion Analytics Dashboard
                </h1>
                <p class="text-white-50 mb-0">Comprehensive overview of student promotion status and academic progression</p>
            </div>
            <div class="col-md-4 text-md-end mt-3 mt-md-0">
                <div class="text-white">
                    <div class="small opacity-75">Academic Session</div>
                    <div class="h4 mb-0">@academicYear</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overall Statistics -->
    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stats-card total">
                <div class="stats-icon total">
                    <i class="fas fa-users"></i>
                </div>
                <div class="stats-number total">@Model.Count()</div>
                <div class="stats-label">Total Students</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card eligible">
                <div class="stats-icon eligible">
                    <i class="fas fa-check-circle"></i>
                </div>
                <div class="stats-number eligible">@Model.Count(s => s.Eligibility == "Eligible")</div>
                <div class="stats-label">Eligible for Promotion</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card conditional">
                <div class="stats-icon conditional">
                    <i class="fas fa-exclamation-triangle"></i>
                </div>
                <div class="stats-number conditional">@Model.Count(s => s.Eligibility == "Conditional")</div>
                <div class="stats-label">Conditional Promotion</div>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stats-card not-eligible">
                <div class="stats-icon not-eligible">
                    <i class="fas fa-times-circle"></i>
                </div>
                <div class="stats-number not-eligible">@Model.Count(s => s.Eligibility == "Not Eligible")</div>
                <div class="stats-label">Not Eligible</div>
            </div>
        </div>
    </div>

    <div class="row g-4">
        <!-- Class Selection & Filters -->
        <div class="col-lg-4">
            <div class="glass-card p-4">
                <h5 class="mb-4">
                    <i class="fas fa-filter me-2"></i>Class Selection & Filters
                </h5>
                <form method="get">
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Select Class</label>
                        <select name="classId" class="form-select" required>
                            <option value="">Choose a class...</option>
                            @foreach (var c in classes)
                            {
                                if (selectedClassId == c.Id)
                                {
                                    <option value="@c.Id" selected>Class @c.ClassName - Section @c.Section</option>
                                }
                                else
                                {
                                    <option value="@c.Id">Class @c.ClassName - Section @c.Section</option>
                                }
                            }
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-semibold">Academic Year</label>
                        <input type="text" name="academicYear" class="form-control" value="@academicYear" />
                        <div class="form-text">Auto-detected academic session</div>
                    </div>
                    <div class="d-grid gap-2">
                        <button type="submit" class="action-btn btn-primary">
                            <i class="fas fa-search me-2"></i>Apply Filters
                        </button>
                        @if (selectedClassId.HasValue)
                        {
                            <a href="@Url.Action("Dashboard", new { classId = (int?)null })" class="btn btn-outline-secondary">
                                <i class="fas fa-times me-2"></i>Clear Filters
                            </a>
                        }
                    </div>
                </form>
                
                @if (classInfo != null)
                {
                    <hr class="my-4" />
                    <div class="mb-3">
                        <div class="small text-muted mb-2">Current Class</div>
                        <div class="fw-semibold">Class @classInfo.ClassName - Section @classInfo.Section</div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted mb-2">Next Class</div>
                        <div class="fw-semibold">@(nextClass?.DisplayName ?? "Not Available")</div>
                    </div>
                    <div class="mb-3">
                        <div class="small text-muted mb-2">Promotion Status</div>
                        <span class="badge bg-@(canPromote ? "success" : "warning") fs-6">
                            @(canPromote ? "✓ Ready for Promotion" : "⚠ Not Ready")
                        </span>
                    </div>
                }
            </div>

            <!-- Quick Actions -->
            <div class="glass-card p-4 mt-4">
                <h5 class="mb-4">
                    <i class="fas fa-bolt me-2"></i>Quick Actions
                </h5>
                <div class="d-grid gap-2">
                    <button class="action-btn btn-info" id="btnPreview" @(selectedClassId.HasValue ? null : "disabled")>
                        <i class="fas fa-eye me-2"></i>Preview Promotion
                    </button>
                    <a href="@Url.Action("ExportSummary", new { classId = selectedClassId ?? 0, academicYear = academicYear })" 
                       class="btn btn-outline-secondary @(selectedClassId.HasValue ? "" : "disabled")">
                        <i class="fas fa-download me-2"></i>Export Summary
                    </a>
                    <form asp-action="PromoteAll" method="post" class="d-inline">
                        @Html.AntiForgeryToken()
                        <input type="hidden" name="classId" value="@selectedClassId" />
                        <input type="hidden" name="academicYear" value="@academicYear" />
                        <button type="submit" class="action-btn btn-success w-100" @(canPromote && selectedClassId.HasValue ? null : "disabled")>
                            <i class="fas fa-graduation-cap me-2"></i>Promote All Eligible
                        </button>
                    </form>
                </div>
            </div>
        </div>

        <!-- Students Table -->
        <div class="col-lg-8">
            <div class="glass-card p-4">
                <div class="d-flex flex-column flex-md-row justify-content-between align-items-md-center gap-3 mb-4">
                    <h5 class="mb-0">
                        <i class="fas fa-users me-2"></i>Student Promotion Status
                    </h5>
                    <div class="d-flex gap-2 flex-wrap">
                        <button class="filter-btn btn-outline-secondary active" data-filter="all">
                            All (@Model.Count())
                        </button>
                        <button class="filter-btn btn-outline-success" data-filter="Eligible">
                            Eligible (@Model.Count(s => s.Eligibility == "Eligible"))
                        </button>
                        <button class="filter-btn btn-outline-warning" data-filter="Conditional">
                            Conditional (@Model.Count(s => s.Eligibility == "Conditional"))
                        </button>
                        <button class="filter-btn btn-outline-danger" data-filter="Not Eligible">
                            Not Eligible (@Model.Count(s => s.Eligibility == "Not Eligible"))
                        </button>
                    </div>
                </div>

                @if (Model.Any())
                {
                    <div class="table-responsive" style="max-height: 60vh;">
                        <table class="table modern-table mb-0">
                            <thead>
                                <tr>
                                    <th>Roll No</th>
                                    <th>Student Name</th>
                                    <th class="text-center">Result %</th>
                                    <th class="text-center">Grade</th>
                                    <th class="text-center">Status</th>
                                    <th>Remarks</th>
                                </tr>
                            </thead>
                            <tbody id="studentBody">
                                @foreach (var s in Model)
                                {
                                    <tr data-elig="@s.Eligibility">
                                        <td class="fw-semibold">@s.Student.RollNumber</td>
                                        <td>
                                            <div class="fw-semibold">@s.Student.FullName</div>
                                            <div class="small text-muted">@s.Student.Email</div>
                                        </td>
                                        <td class="text-center">
                                            @(s.Result != null ? s.Result.Percentage.ToString("0.##") : "—")%
                                        </td>
                                        <td class="text-center fw-bold">@s.Result?.Grade</td>
                                        <td class="text-center">
                                            <span class="status-badge status-@s.Eligibility.Replace(" ", "\u00A0")">
                                                @s.Eligibility
                                            </span>
                                        </td>
                                        <td class="text-muted small">@s.Result?.Remarks</td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-users-graduate"></i>
                        </div>
                        <h4 class="text-muted mb-3">No Students Found</h4>
                        <p class="text-muted">
                            Select a class to view students and their promotion eligibility status.
                        </p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

@section Scripts {
<script>
    document.querySelectorAll('[data-filter]').forEach(btn => {
        btn.addEventListener('click', function(e){
            e.preventDefault();
            const f = this.getAttribute('data-filter');
            document.querySelectorAll('#studentBody tr').forEach(tr => {
                const val = tr.getAttribute('data-elig');
                tr.style.display = (f === 'all' || val === f) ? '' : 'none';
            });
        });
    });

    const previewBtn = document.getElementById('btnPreview');
    if (previewBtn) {
        previewBtn.addEventListener('click', async function(){
            const classId = '@(selectedClassId ?? 0)';
            const ay = '@academicYear';
            if (!classId || classId === '0') return;
            try {
                const res = await fetch(`@Url.Action("Preview")?classId=${classId}&academicYear=${encodeURIComponent(ay)}`);
                const data = await res.json();
                const msg = `Next Class: ${data.nextClass || '—'}\nReady: ${data.canPromote ? 'Yes' : 'No'}${data.isMatric ? '\nMatric Class: Yes' : ''}`;
                alert(msg);
            } catch (e) {
                alert('Unable to preview right now.');
            }
        });
    }
</script>
}
