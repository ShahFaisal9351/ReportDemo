@model List<ReportDemo.Models.ExamResult>

@{
    ViewData["Title"] = "Bulk Record Results";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="content-wrapper">
    <!-- Content Header -->
    <section class="content-header">
        <div class="container-fluid">
            <div class="row mb-2">
                <div class="col-sm-6">
                    <h1>
                        <i class="fas fa-upload text-primary"></i>
                        Bulk Record Results - @ViewBag.Class.ClassName @ViewBag.Class.Section
                    </h1>
                </div>
                <div class="col-sm-6">
                    <ol class="breadcrumb float-sm-right">
                        <li class="breadcrumb-item"><a href="/">Home</a></li>
                        <li class="breadcrumb-item"><a href="/Exam">Exam Results</a></li>
                        <li class="breadcrumb-item active">Bulk Record</li>
                    </ol>
                </div>
            </div>
        </div>
    </section>

    <!-- Main content -->
    <section class="content">
        <div class="container-fluid">
            <!-- Info Alert -->
            <div class="alert alert-info alert-dismissible fade show" role="alert">
                <h5><i class="icon fas fa-info-circle"></i> Bulk Entry Made Easy!</h5>
                Enter exam results for all students in <strong>@ViewBag.Class.ClassName @ViewBag.Class.Section</strong>. 
                Grades will be calculated automatically based on percentages.
                <button type="button" class="close" data-dismiss="alert" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
                </button>
            </div>

            <!-- Class Info -->
            <div class="row mb-4">
                <div class="col-md-12">
                    <div class="card card-info">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <strong>Class:</strong> @ViewBag.Class.ClassName @ViewBag.Class.Section
                                </div>
                                <div class="col-md-3">
                                    <strong>Academic Year:</strong> @ViewBag.AcademicYear
                                </div>
                                <div class="col-md-3">
                                    <strong>Students:</strong> @Model.Count
                                </div>
                                <div class="col-md-3">
                                    <a href="@Url.Action("Index")" class="btn btn-secondary">
                                        <i class="fas fa-arrow-left mr-1"></i> Back to Results
                                    </a>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Bulk Results Form -->
            <form asp-action="BulkRecordResults" method="post">
                <input type="hidden" name="classId" value="@ViewBag.Class.Id" />
                
                <div class="card card-primary">
                    <div class="card-header">
                        <h3 class="card-title">
                            <i class="fas fa-users mr-2"></i>
                            Enter Results for All Students
                        </h3>
                        <div class="card-tools">
                            <button type="button" id="fillSampleBtn" class="btn btn-info btn-sm">
                                <i class="fas fa-flask mr-1"></i> Fill Sample
                            </button>
                            <button type="button" id="clearAllBtn" class="btn btn-warning btn-sm">
                                <i class="fas fa-eraser mr-1"></i> Clear All
                            </button>
                        </div>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-striped table-hover">
                                <thead class="thead-dark">
                                    <tr>
                                        <th width="5%">#</th>
                                        <th width="25%">Student Name</th>
                                        <th width="15%">Roll Number</th>
                                        <th width="15%">Percentage</th>
                                        <th width="10%">Grade</th>
                                        <th width="10%">Status</th>
                                        <th width="20%">Remarks</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @for (int i = 0; i < Model.Count; i++)
                                    {
                                        <tr>
                                            <td>@(i + 1)</td>
                                            <td>
                                                <strong>@Model[i].Student.FullName</strong>
                                                <input type="hidden" name="[@i].StudentId" value="@Model[i].StudentId" />
                                                <input type="hidden" name="[@i].Id" value="@Model[i].Id" />
                                            </td>
                                            <td>
                                                <span class="badge badge-secondary">@Model[i].Student.RollNumber</span>
                                            </td>
                                            <td>
                                                <input type="number" 
                                                       name="[@i].Percentage" 
                                                       value="@Model[i].Percentage" 
                                                       class="form-control percentage-input"
                                                       min="0" 
                                                       max="100" 
                                                       step="0.1" 
                                                       data-index="@i" />
                                            </td>
                                            <td>
                                                <span class="grade-display badge" data-index="@i">@Model[i].Grade</span>
                                            </td>
                                            <td>
                                                <span class="status-display badge" data-index="@i">
                                                    @(Model[i].IsPassed ? "Pass" : "Fail")
                                                </span>
                                            </td>
                                            <td>
                                                <input type="text" 
                                                       name="[@i].Remarks" 
                                                       value="@Model[i].Remarks" 
                                                       class="form-control form-control-sm"
                                                       placeholder="Optional" />
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <div class="card-footer">
                        <div class="row">
                            <div class="col-md-6">
                                <button type="submit" class="btn btn-success btn-lg">
                                    <i class="fas fa-save mr-2"></i>
                                    Save All Results
                                </button>
                            </div>
                            <div class="col-md-6 text-right">
                                <a href="@Url.Action("Index")" class="btn btn-secondary btn-lg">
                                    <i class="fas fa-times mr-2"></i>
                                    Cancel
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </section>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Calculate grade function
            function calculateGrade(percentage) {
                if (percentage >= 90) return 'A+';
                if (percentage >= 80) return 'A';
                if (percentage >= 70) return 'B';
                if (percentage >= 60) return 'C';
                if (percentage >= 40) return 'D';
                return 'F';
            }

            // Update grade and status when percentage changes
            $('.percentage-input').on('input', function() {
                const index = $(this).data('index');
                const percentage = parseFloat($(this).val()) || 0;
                const grade = calculateGrade(percentage);
                const status = percentage >= 40 ? 'Pass' : 'Fail';
                
                // Update grade display
                const gradeDisplay = $(`.grade-display[data-index="${index}"]`);
                gradeDisplay.text(grade);
                gradeDisplay.removeClass('badge-success badge-danger');
                gradeDisplay.addClass(grade === 'F' ? 'badge-danger' : 'badge-success');
                
                // Update status display
                const statusDisplay = $(`.status-display[data-index="${index}"]`);
                statusDisplay.text(status);
                statusDisplay.removeClass('badge-success badge-danger');
                statusDisplay.addClass(status === 'Pass' ? 'badge-success' : 'badge-danger');
            });

            // Fill Sample Data button
            $('#fillSampleBtn').click(function() {
                $('.percentage-input').each(function() {
                    const randomPercentage = Math.floor(Math.random() * 40) + 40; // 40-80%
                    $(this).val(randomPercentage).trigger('input');
                });
            });

            // Clear All button
            $('#clearAllBtn').click(function() {
                $('.percentage-input').val('').trigger('input');
                $('input[name$=".Remarks"]').val('');
            });

            // Trigger initial calculation for existing values
            $('.percentage-input').each(function() {
                if ($(this).val()) {
                    $(this).trigger('input');
                }
            });
        });
    </script>
}

<style>
    .percentage-input {
        text-align: center;
        font-weight: 600;
    }
    
    .grade-display, .status-display {
        font-size: 0.9rem;
        font-weight: bold;
    }
    
    .table th {
        font-weight: 600;
    }
    
    .card {
        border-radius: 0.5rem;
    }
</style>
